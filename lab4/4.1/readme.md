
## 4.1 Linux kernel timers

Cron mechanism provides high configurability, but is limited one minute resolution. Linux kernel timers can be applied from C code with sub-millisecond accuracy (some jitter is generated by OS processes taking CPU time). This folder contains provides an example of using the timers. Three timers are set up, and each timer event will trigger execution of handler code. Build, debug and study the example.

```
Note!

Timer-related functions can be found in librt-library, which is included in CMakeLists.txt. Unfortunately there is a a broken symbolic link in the build environment.

$ ls -l /var/lib/schroot/chroots/rpizero-bullseye-armhf/usr/lib/arm-linux-gnueabihf/librt.so*

lrwxrwxrwx 1 root root 35 loka   18 17:24 /var/lib/schroot/chroots/rpizero-bullseye-armhf/usr/lib/arm-linux-gnueabihf/librt.so -> /lib/arm-linux-gnueabihf/librt.so.1

lrwxrwxrwx 1 root root 13 loka   18 17:24 /var/lib/schroot/chroots/rpizero-bullseye-armhf/usr/lib/arm-linux-gnueabihf/librt.so.1 -> librt-2.31.so


Fix that by first removing the broken link (the upper one) and create a new symbolic link, which points to librt-2.31.so in the same directory (see the lower link).

ln -s <source_file> <symbolic_link>

Under lab 4.1 you will find a script "fix_broken_lib_links.sh", which will correct (hopefully) all the broken links. 

```

### Exercise 4.1: kernel timers

Modify kernel timer example to produce software generated PWM pulses for a servo motor. Servo pulses shall occur every 20 milliseconds and the nominal pulse length for servo middle position is 1.5ms. The angular position is controlled with pulse modulation, where pulse width can vary from 1.0 ms to 2.0 ms.  
- Modify the timer function interfaces to operate with microseconds instead of milliseconds. Check all places where changed variables are used in calculations, and correct those calculations accordingly.
- Create one timer task that activates every 20 milliseconds (PWM pulse start event). Bring in necessary header files and add GPIO output pin, and for testing, make it toggle every time event handler is called. Check with oscilloscope that output meets your expectations.
- In same event handler, create a new timer for PWM pulse length (between 1 and 2 milliseconds, the actual value does not matter at this phase). Create timer handler for this pulse stop timer. In handler, turn off the output (and in pulse start event replace the toggle with plain output activation to high state). Debug and verify with oscilloscope. Measure jitter.
- Get a real servo (choose a standard servo, as there are continuous-running servos as well) and connect it to raspi. Red wire to +5V, Black wire to GND, and white wire to your GPIO control pin. Test.
- Commit updated code to your repository.
